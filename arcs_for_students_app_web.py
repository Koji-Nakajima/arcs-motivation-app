# arcs_for_students_web.py
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime
import streamlit.components.v1 as components

# --- matplotlibã®è‹±å­—ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆç’°å¢ƒä¾å­˜ãªã—ï¼‰ ---
plt.rcParams['font.family'] = 'sans-serif'
plt.rcParams['font.sans-serif'] = ['Arial', 'DejaVu Sans', 'sans-serif']

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(page_title="ARCS ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³è¨ºæ–­", layout="centered")

st.title("ğŸ“ å­¦ç¿’ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³è¨ºæ–­")
st.write("ä»¥ä¸‹ã®è³ªå•ã«1ã€œ100ã§ç­”ãˆã¦ã€ã“ã®ç§‘ç›®ãƒ»èª²é¡Œã«å¯¾ã™ã‚‹ä»Šã®ã‚ãªãŸã®ã€Œã‚„ã‚‹æ°—ã€ã‚’åˆ†æã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚")

# --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  ---
with st.form("arcs_form"):
    name = st.text_input("ãŠåå‰ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¯ï¼‰")
    user_id = st.text_input("å­¦ç±ç•ªå·ã¾ãŸã¯ID")
    attention = st.slider("1. ï¼ˆæŒ‡å®šã•ã‚ŒãŸç§‘ç›®ãƒ»èª²é¡Œã«ã¤ã„ã¦ï¼‰å­¦ç¿’ã«ãƒ¯ã‚¯ãƒ¯ã‚¯æ„ŸãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ", 1, 100, 50)
    relevance = st.slider("2. ã“ã“ã§ã®å­¦ã³ã¯è‡ªåˆ†ã«é–¢ä¿‚ãŒã‚ã‚‹ã¨æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ", 1, 100, 50)
    confidence = st.slider("3. ã“ã®ç§‘ç›®ãƒ»èª²é¡Œã‚’ã‚„ã‚Šãã‚Œã‚‹è‡ªä¿¡ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", 1, 100, 50)
    satisfaction = st.slider("4. ã“ã“ã¾ã§ã®è‡ªåˆ†ã®å­¦ã³ã«æº€è¶³ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ", 1, 100, 50)
    submitted = st.form_submit_button("è¨ºæ–­ã™ã‚‹")

if submitted:
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # --- ã‚¢ãƒ‰ãƒã‚¤ã‚¹æ§‹ç¯‰ ---
    st.subheader("ğŸ” è¨ºæ–­çµæœ")
    st.markdown("è‡ªå·±åˆ†æã§30ç‚¹æœªæº€ã‚’é¸ã‚“ã é …ç›®ã«ã¤ã„ã¦ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹")
    st.markdown("---")

    advice_blocks = []

    if attention < 30:
        advice_blocks.append({
            "question": "ï¼ˆæŒ‡å®šã•ã‚ŒãŸç§‘ç›®ãƒ»èª²é¡Œã«ã¤ã„ã¦ï¼‰å­¦ç¿’ã«ãƒ¯ã‚¯ãƒ¯ã‚¯æ„ŸãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
            "score": attention,
            "advice": "æœ€è¿‘ã®å­¦ç¿’ãŒé€€å±ˆã«æ„Ÿã˜ã‚‹ãªã‚‰ã€ã€Œè‰²ã‚’ä½¿ã£ã¦ãƒãƒ¼ãƒˆã‚’æ•´ç†ã—ã¦ã¿ã‚‹ã€ã€Œç”ŸæˆAIã‚’ä½¿ã£ã¦ã€å­¦ç¿’å†…å®¹ã‚’ã‚¯ã‚¤ã‚ºå½¢å¼ã«ã—ã¦ã¿ã‚‹ã€ã¨ã„ã£ãŸå·¥å¤«ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
            "evaluation": "æ¬¡ã®å­¦ç¿’æ™‚ã«ã€Œå†…å®¹ã‚’æ€ã„å‡ºã—ã‚„ã™ã‹ã£ãŸã‹ã€ã€Œæ¬¡ã«å­¦ã¶ã“ã¨ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã§ããŸã‹ã€ã‚’æŒ¯ã‚Šè¿”ã£ã¦â—‹â–³Ã—ã§è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚"
        })

    if relevance < 30:
        advice_blocks.append({
            "question": "ã“ã“ã§ã®å­¦ã³ã¯è‡ªåˆ†ã«é–¢ä¿‚ãŒã‚ã‚‹ã¨æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",
            "score": relevance,
            "advice": "å­¦ã‚“ã§ã„ã‚‹ã“ã¨ãŒè‡ªåˆ†ã«é–¢ä¿‚ãªã„ã¨æ„Ÿã˜ãŸã‚‰ã€ã€Œã“ã“ã§å­¦ã¶çŸ¥è­˜ã‚„ã‚¹ã‚­ãƒ«ãŒå°†æ¥ã©ã‚“ãªã“ã¨ã«å½¹ç«‹ã¤ã‹ã€ã‚’æ¤œç´¢ã—ã¦ã€å…·ä½“ä¾‹ã‚’æ›¸ãå‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
            "evaluation": "ä¾‹ã‚’æ¢ã—ãŸã‚ã¨ã®æ°—æŒã¡ã‚’æ›¸ãå‡ºã—ã¦ã€ã€Œè‡ªåˆ†ã¨ã®é–¢é€£æ€§ã‚’ã€è‡ªåˆ†ãªã‚Šã«ç´å¾—ã§ããŸã‹ã€ã‚’ãƒ¡ãƒ¢ã«æ®‹ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚"
        })

    if confidence < 30:
        advice_blocks.append({
            "question": "ã“ã®ç§‘ç›®ãƒ»èª²é¡Œã‚’ã‚„ã‚Šãã‚Œã‚‹è‡ªä¿¡ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
            "score": confidence,
            "advice": "é›£ã—ãã†ã ã¨æ„Ÿã˜ãŸã‚‰ã€ã€Œä¸€ç•ªç°¡å˜ãã†ãªã¨ã“ã‚ã ã‘ã‚„ã£ã¦ã¿ã‚‹ã€ã€Œ5åˆ†ã ã‘ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆã—ã¦å–ã‚Šã‹ã‹ã‚‹ã€ãªã©ã€ç´°åˆ‡ã‚Œã«ã—ã¦ã§ãã‚‹ã¨ã“ã‚ã‹ã‚‰é †ç•ªã«é€²ã‚ã‚‹æ–¹æ³•ã‚’å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
            "evaluation": "ç´°åˆ‡ã‚Œã«ã—ã¦ã¿ãŸå¾Œã€ã€Œã‚„ã£ã¦ã¿ãŸã‚‰æ¡ˆå¤–ã§ããŸã‹ï¼Ÿã€ã‚’æ€ã„å‡ºã—ã¦ã€â—‹Ã—â–³ã§è¨˜éŒ²ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚"
        })

    if satisfaction < 30:
        advice_blocks.append({
            "question": "ã“ã“ã¾ã§ã®è‡ªåˆ†ã®å­¦ã³ã«æº€è¶³ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
            "score": satisfaction,
            "advice": "ã“ã“ã¾ã§ã«å­¦ã‚“ã ã“ã¨ã‚’ã€Œä¸€è¨€ã§èª¬æ˜ã™ã‚‹ã€ã€Œå‹é”ã‚„å®¶æ—ã«è©±ã™ã€ã€ŒSNSã‚„æ—¥è¨˜ã«æ›¸ãã€ãªã©ã€è¨€è‘‰ã«ã—ã¦ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã™ã‚‹ã“ã¨ã§é”æˆæ„Ÿã‚’å¾—ã‚„ã™ããªã‚Šã¾ã™ã€‚",
            "evaluation": "ãã®è¡Œå‹•ã®å¾Œã€ã€Œæ°—åˆ†ãŒå°‘ã—ã§ã‚‚ã‚ˆããªã£ãŸã‹ã©ã†ã‹ã€ã€ŒæŒ¯ã‚Šè¿”ã£ã¦æ„å‘³ã‚’æ„Ÿã˜ã‚‰ã‚ŒãŸã‹ã€ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚"
        })

    if not advice_blocks:
        advice_blocks.append({
            "question": "å…¨ä½“ã®çŠ¶æ…‹",
            "score": "-",
            "advice": "ç¾åœ¨ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã¯è‰¯å¥½ã®ã‚ˆã†ã§ã™ã€‚ã“ã®èª¿å­ã§ç¶™ç¶šã—ã¦å­¦ç¿’ã‚’é€²ã‚ã¾ã—ã‚‡ã†ï¼",
            "evaluation": "å®šæœŸçš„ã«è¨˜éŒ²ã—ã¦ã€çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç¢ºèªã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚"
        })

    # --- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãªã—ï¼‰ ---
    html_blocks = f"""
    <div style="font-family: Arial, sans-serif; border:1px solid #ccc; padding:20px;">
    <p><strong>æ°åï¼š</strong>{name}ã€€ã€€<strong>æ—¥æ™‚ï¼š</strong>{now}</p>
    <p style="margin-top: 1em; color: #444;">ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯å°åˆ·ã™ã‚‹ã‹ã€PDFç­‰ã§ä¿å­˜ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚</p>
    <p style="margin-top: 1.5em;"><strong style="font-size: 20px;">ã€ã‚¹ã‚³ã‚¢ã€‘</strong><br>
    <span style="font-size: 22px;">æ³¨æ„: {attention}ï½œé–¢é€£æ€§: {relevance}ï½œè‡ªä¿¡: {confidence}ï½œæº€è¶³æ„Ÿ: {satisfaction}</span></p>
    <hr>
    """
    for block in advice_blocks:
        html_blocks += f"""
        <h4>â–  è³ªå•ï¼š{block['question']}</h4>
        <p><strong>â–¶ ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š</strong>{block['advice']}</p>
        <p><strong>â–¶ è‡ªå·±è©•ä¾¡æ–¹æ³•ï¼š</strong>{block['evaluation']}</p>
        <hr>
        """
    html_blocks += "</div>"
    components.html(html_blocks, height=800, scrolling=True)

    # --- æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆè¨ºæ–­çµæœã®ã¿ã‚’å¯è¦–åŒ–ï¼‰ ---
    st.markdown("---")
    st.subheader("ğŸ“Š ã€Œã‚„ã‚‹æ°—ã€ã®è¦å› åˆ¥ æ¨ç§»ã‚°ãƒ©ãƒ•")

    # 1å›ã®è¨ºæ–­çµæœã ã‘ã‚’ä½¿ã£ã¦ã‚°ãƒ©ãƒ•
    df_result = pd.DataFrame({
        'é …ç›®': ['Attention', 'Relevance', 'Confidence', 'Satisfaction'],
        'ã‚¹ã‚³ã‚¢': [attention, relevance, confidence, satisfaction]
    })

    fig, ax = plt.subplots(figsize=(8, 4))
    ax.bar(df_result['é …ç›®'], df_result['ã‚¹ã‚³ã‚¢'])
    ax.set_ylim(0, 100)
    ax.set_ylabel("Score (1â€“100)")
    ax.set_title(f"{name}'s Current Motivation")
    ax.grid(axis='y')
    st.pyplot(fig)

    st.markdown("""
    ğŸ“ **å‡¡ä¾‹ã®æ„å‘³ï¼š**
    - Attention = æ³¨æ„ï¼ˆå­¦ç¿’ã«é–¢å¿ƒãŒå‘ã„ã¦ã„ã‚‹ã‹ã©ã†ã‹ï¼‰
    - Relevance = é–¢é€£æ€§ï¼ˆå­¦ç¿’å†…å®¹ã‚„æ–¹æ³•ãŒã€è‡ªåˆ†ã«é–¢é€£æ€§ãŒã‚ã‚‹ã€æ„å‘³ãŒã‚ã‚‹ã¨æ„Ÿã˜ã‚‰ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ï¼‰
    - Confidence = è‡ªä¿¡ï¼ˆå­¦ç¿’ã‚’æœ€å¾Œã¾ã§ã‚„ã‚Šãã‚Œã‚‹ã¨ã„ã†è¦‹é€šã—ãŒçµŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ï¼‰
    - Satisfaction = æº€è¶³æ„Ÿï¼ˆå­¦ç¿’ã—ãŸçµæœã«å¯¾ã™ã‚‹é”æˆæ„Ÿã‚„ç´å¾—æ„ŸãŒã‚ã‚‹ã‹ã©ã†ã‹ï¼‰
    """)
